{% extends 'layouts/base.html' %}

{% block title %} {{ project.name }} Timeline {% endblock title %}

{% block content %}

<div class="header bg-gradient-primary pb-8 pt-5 pt-md-8">
  <div class="container-fluid">
    <div class="header-body">
      <div class="row">
        <div class="col-xl-12 col-lg-12">
          <div class="card card-stats mb-4 mb-xl-0">
            <div class="card-body">
              <div class="row">
                <div class="col">
                  <h5 class="card-title text-uppercase text-muted mb-0">Project Timeline</h5>
                  <span class="h2 font-weight-bold mb-0">{{ project.name }}</span>
                </div>
                <div class="col-auto">
                    <a href="{% url 'projects' %}" class="btn btn-sm btn-primary">Back to Projects</a>
                </div>
              </div>
              <p class="mt-3 mb-0 text-muted text-sm">
                <span class="text-nowrap">Start: {{ project.start }}</span> | 
                <span class="text-nowrap">Deadline: {{ project.end }}</span>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid mt--7">
  <div class="row">
    <div class="col">
      <div class="card shadow">
        <div class="card-header bg-transparent">
          <h3 class="mb-0">Gantt Chart Visualization</h3>
        </div>
        <div class="card-body">
          <div id="chart_div" style="min-height: 500px;">
             <p class="text-center text-muted mt-5" id="loading_msg">Loading Timeline...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% include "includes/footer.html" %}
</div>

{% endblock content %}

{% block javascripts %}
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
  google.charts.load('current', {'packages':['gantt']});
  google.charts.setOnLoadCallback(drawChart);

  function drawChart() {
    // 1. Get Data from Django
    var rawData = {{ gantt_data|safe }};
    
    // 2. Check if data is empty BEFORE trying to draw
    if (!rawData || rawData.length === 0) {
        document.getElementById('chart_div').innerHTML = '<div class="alert alert-warning text-center">No tasks found for this project. Add tasks to generate the timeline.</div>';
        return;
    }

    document.getElementById('loading_msg').style.display = 'none';

    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Task ID');
    data.addColumn('string', 'Task Name');
    data.addColumn('string', 'Resource');
    data.addColumn('date', 'Start Date');
    data.addColumn('date', 'End Date');
    data.addColumn('number', 'Duration');
    data.addColumn('number', 'Percent Complete');
    data.addColumn('string', 'Dependencies');

    // 3. Safer Date Parsing Function
    // Splits "2024-05-20" into integers to avoid timezone issues with new Date()
    function parseDate(dateStr) {
        if (!dateStr) return null;
        var parts = dateStr.split('-');
        // Note: Month is 0-indexed in Javascript (0 = Jan, 1 = Feb)
        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    }

    var rows = rawData.map(function(item) {
        return [
            item[0],                // Task ID
            item[1],                // Task Name
            item[2],                // Resource
            parseDate(item[3]),     // Start Date (Using helper function)
            parseDate(item[4]),     // End Date (Using helper function)
            item[5],                // Duration
            item[6],                // Percent
            item[7]                 // Dependencies
        ];
    });

    data.addRows(rows);

    // Dynamic height based on number of tasks (45px per row + padding)
    var chartHeight = rows.length * 45 + 50;

    var options = {
      height: chartHeight,
      gantt: {
        trackHeight: 40,
        barCornerRadius: 4,
        percentEnabled: true,
        backgroundColor: {
            fill: '#ffffff'
        },
        palette: [
            {
              "color": "#5e72e4", // Theme Blue
              "dark": "#233dd2",
              "light": "#eef0fc"
            }
        ]
      }
    };

    var chart = new google.visualization.Gantt(document.getElementById('chart_div'));
    chart.draw(data, options);
  }
</script>
{% endblock javascripts %}