{% extends 'layouts/base.html' %}

{% block title %} Icons {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<style>
  .calendar-top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
  .btn-new-calendar {
    background-color: #007bff;
    color: #fff;
    padding: 8px 14px;
    border-radius: 6px;
    border: none;
    font-weight:600;
    cursor: pointer;
  }
  .btn-new-calendar:hover { background-color: #0069d9; }

  .calendar-container { min-height:480px; display:flex; flex-direction:column; }
  .calendar-placeholder { flex:1; display:flex; align-items:center; justify-content:center; color:#666; border:2px dashed #e9ecef; border-radius:8px; padding:30px; width:100%; }
  .calendar-iframe { width:100%; height:600px; border:0; border-radius:8px; overflow:hidden; }

  /* Modal overlay similar to kanban */
  .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; align-items:center; justify-content:center; }
  .overlay.active { display:flex; }
  .modal-content { background:#fff; padding:24px; border-radius:8px; width:94%; max-width:620px; box-shadow:0 6px 30px rgba(0,0,0,0.2); }
  .modal-header { font-size:18px; font-weight:700; margin-bottom:12px; }
  .form-group { margin-bottom:12px; }
  .form-group label { font-weight:600; display:block; margin-bottom:6px; }
  .form-group input { width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; }
  .modal-buttons { display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
  .btn-save { background:#28a745; color:#fff; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
  .btn-cancel { background:#e9ecef; color:#333; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
  .error-message { color:#dc3545; font-size:13px; display:none; margin-top:6px; }
  .error-message.active { display:block; }

  /* Calendar events styling */
  .calendar-events-section { margin-top:20px; padding:15px; background:#f8f9fa; border-radius:8px; }
  .calendar-events-header { font-weight:600; font-size:14px; margin-bottom:10px; color:#333; }
  .calendar-event-item {
    padding:10px;
    margin-bottom:8px;
    background:#fff;
    border-left:4px solid #007bff;
    border-radius:4px;
    font-size:13px;
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
  }
  .calendar-event-item:hover { background:#f0f5ff; }
  .calendar-event-content { flex:1; }
  .calendar-event-actions {
    display:flex;
    gap:6px;
    margin-left:10px;
  }
  .calendar-event-actions button {
    padding:4px 8px;
    font-size:11px;
    border:none;
    border-radius:3px;
    cursor:pointer;
    white-space:nowrap;
  }
  .btn-edit-event { background:#ffc107; color:#333; }
  .btn-edit-event:hover { background:#ffb300; }
  .btn-delete-event { background:#dc3545; color:#fff; }
  .btn-delete-event:hover { background:#c82333; }
  .calendar-event-title { font-weight:600; color:#333; }
  .calendar-event-date { color:#666; font-size:12px; margin-top:4px; }
  .calendar-event-project { color:#888; font-size:11px; margin-top:2px; }
  
  /* New event button styling */
  .btn-new-event {
    background-color: #28a745;
    color: #fff;
    padding: 8px 14px;
    border-radius: 6px;
    border: none;
    font-weight:600;
    cursor: pointer;
    margin-left: 8px;
  }
  .btn-new-event:hover { background-color: #218838; }
</style>
{% endblock stylesheets %}

{% block content %}

    <!-- Header -->
    <div class="header bg-gradient-primary pb-8 pt-5 pt-md-8">
<script src="/static/assets/vendor/clipboard/dist/clipboard.min.js"></script>

<!-- Calendar modal overlay -->
<div class="overlay" id="calendarOverlay">
  <div class="modal-content">
    <div class="modal-header">Add Google Calendar Embed</div>
    <div>
      <div class="form-group">
        <label for="calendarLink">Google Calendar embed URL or iframe src</label>
        <input type="text" id="calendarLink" placeholder="e.g. https://calendar.google.com/calendar/embed?src=...">
        <div class="error-message" id="calendarError">Please enter a valid URL.</div>
      </div>
      <div class="form-group">
        <label for="calendarTitle">Optional title (shown when no calendar)</label>
        <input type="text" id="calendarTitle" placeholder="My Team Calendar">
      </div>
      <div class="modal-buttons">
        <button type="button" class="btn-cancel" onclick="closeCalendarModal()">Cancel</button>
        <button type="button" class="btn-save" onclick="saveCalendar()">Save</button>
      </div>
      <div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end;">
        <button type="button" class="btn-cancel" onclick="removeCalendar()">Remove Calendar</button>
      </div>
    </div>
  </div>
</div>

<!-- Event creation/editing modal -->
<div class="overlay" id="eventModal">
  <div class="modal-content">
    <div class="modal-header"><span id="eventModalTitle">Create Calendar Event</span></div>
    <div>
      <div class="form-group">
        <label for="eventTitle">Event Title *</label>
        <input type="text" id="eventTitle" placeholder="e.g. Team Meeting">
        <div class="error-message" id="eventTitleError"></div>
      </div>
      <div class="form-group">
        <label for="eventDescription">Description</label>
        <input type="text" id="eventDescription" placeholder="Optional description">
      </div>
      <div class="form-group">
        <label for="eventStartDate">Start Date *</label>
        <input type="date" id="eventStartDate">
        <div class="error-message" id="eventStartDateError"></div>
      </div>
      <div class="form-group">
        <label for="eventEndDate">End Date</label>
        <input type="date" id="eventEndDate">
      </div>
      <div class="modal-buttons">
        <button type="button" class="btn-cancel" onclick="closeEventModal()">Cancel</button>
        <button type="button" class="btn-save" onclick="saveEvent()">Save Event</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Key used in localStorage
  const CAL_KEY = 'planny_user_calendar_src';
  const CAL_TITLE_KEY = 'planny_user_calendar_title';
  let currentEditingEventId = null;

  document.addEventListener('DOMContentLoaded', () => {
    loadCalendar();
    // close overlay when clicking outside modal
    document.getElementById('calendarOverlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeCalendarModal();
    });
    document.getElementById('eventModal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeEventModal();
    });
  });

  function openCalendarModal() {
    const overlay = document.getElementById('calendarOverlay');
    const input = document.getElementById('calendarLink');
    const titleInput = document.getElementById('calendarTitle');
    const saved = localStorage.getItem(CAL_KEY);
    const savedTitle = localStorage.getItem(CAL_TITLE_KEY);
    input.value = saved || '';
    titleInput.value = savedTitle || '';
    document.getElementById('calendarError').classList.remove('active');
    overlay.classList.add('active');
  }

  function closeCalendarModal() {
    document.getElementById('calendarOverlay').classList.remove('active');
  }

  function saveCalendar() {
    const input = document.getElementById('calendarLink').value.trim();
    const title = document.getElementById('calendarTitle').value.trim();
    const err = document.getElementById('calendarError');
    err.classList.remove('active');

    if (!input) {
      err.textContent = 'Please enter a calendar URL or iframe src.';
      err.classList.add('active');
      return;
    }

    // Basic validation: must look like a URL
    try {
      const url = new URL(input);
      // Accept any URL, but suggest Google Calendar embeds
      localStorage.setItem(CAL_KEY, input);
      localStorage.setItem(CAL_TITLE_KEY, title);
      closeCalendarModal();
      loadCalendar();
    } catch (e) {
      // Might be an iframe snippet - attempt to extract src
      const srcMatch = input.match(/src\s*=\s*"([^"]+)"/i);
      if (srcMatch && srcMatch[1]) {
        localStorage.setItem(CAL_KEY, srcMatch[1]);
        localStorage.setItem(CAL_TITLE_KEY, title);
        closeCalendarModal();
        loadCalendar();
        return;
      }
      err.textContent = 'Invalid URL or iframe. Provide a full URL or iframe snippet.';
      err.classList.add('active');
    }
  }

  function removeCalendar() {
    localStorage.removeItem(CAL_KEY);
    localStorage.removeItem(CAL_TITLE_KEY);
    closeCalendarModal();
    loadCalendar();
  }

  // Event CRUD functions
  function openEventModal(eventId = null) {
    currentEditingEventId = eventId;
    const modal = document.getElementById('eventModal');
    const header = document.getElementById('eventModalTitle');
    
    // Clear form
    document.getElementById('eventTitle').value = '';
    document.getElementById('eventDescription').value = '';
    document.getElementById('eventStartDate').value = '';
    document.getElementById('eventEndDate').value = '';
    clearErrorMessages();

    if (eventId) {
      // Editing mode - fetch event details
      header.textContent = 'Edit Calendar Event';
      fetchEventDetails(eventId);
    } else {
      // Creating mode
      header.textContent = 'Create Calendar Event';
      // Pre-fill with today's date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('eventStartDate').value = today;
    }

    modal.classList.add('active');
  }

  function closeEventModal() {
    document.getElementById('eventModal').classList.remove('active');
    currentEditingEventId = null;
    clearErrorMessages();
  }

  function clearErrorMessages() {
    document.getElementById('eventTitleError').classList.remove('active');
    document.getElementById('eventStartDateError').classList.remove('active');
  }

  function fetchEventDetails(eventId) {
    fetch(`/api/user-calendar-events/${eventId}/`)
      .then(r => r.ok ? r.json() : Promise.reject('Failed to load event'))
      .catch(err => {
        console.error('Error fetching event:', err);
        alert('Failed to load event details');
        closeEventModal();
      });
  }

  function saveEvent() {
    const title = document.getElementById('eventTitle').value.trim();
    const description = document.getElementById('eventDescription').value.trim();
    const startDate = document.getElementById('eventStartDate').value;
    const endDate = document.getElementById('eventEndDate').value;

    clearErrorMessages();

    // Validation
    if (!title) {
      document.getElementById('eventTitleError').textContent = 'Event title is required';
      document.getElementById('eventTitleError').classList.add('active');
      return;
    }

    if (!startDate) {
      document.getElementById('eventStartDateError').textContent = 'Start date is required';
      document.getElementById('eventStartDateError').classList.add('active');
      return;
    }

    const eventData = {
      eventTitle: title,
      eventDescription: description,
      startDate: startDate,
      endDate: endDate || startDate
    };

    const method = currentEditingEventId ? 'PATCH' : 'POST';
    const url = currentEditingEventId 
      ? `/api/user-calendar-events/${currentEditingEventId}/`
      : '/api/user-calendar-events/';

    fetch(url, {
      method: method,
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(eventData)
    })
    .then(r => r.ok ? r.json() : Promise.reject('Failed to save event'))
    .then(data => {
      closeEventModal();
      loadCalendar();
    })
    .catch(err => {
      console.error('Error saving event:', err);
      alert('Failed to save event');
    });
  }

  function deleteEvent(eventId) {
    if (!confirm('Are you sure you want to delete this event?')) return;

    fetch(`/api/user-calendar-events/${eventId}/`, {
      method: 'DELETE'
    })
    .then(r => r.ok ? r.json() : Promise.reject('Failed to delete event'))
    .then(data => {
      loadCalendar();
    })
    .catch(err => {
      console.error('Error deleting event:', err);
      alert('Failed to delete event');
    });
  }

  function loadCalendar() {
    const src = localStorage.getItem(CAL_KEY);
    const title = localStorage.getItem(CAL_TITLE_KEY) || '';
    const area = document.getElementById('calendarArea');
    area.innerHTML = '';

    // Helper to fetch server-side user calendar events and then render combined list
    function fetchAndDisplay(serverContainer) {
      // Fetch user-persisted calendar events
      fetch('/api/user-calendar-events/')
        .then(r => r.ok ? r.json() : Promise.reject('Failed to fetch user calendar events'))
        .then(data => {
          const userEvents = data && data.events ? data.events : [];
          // Also fetch auto-generated task events from tasks
          return fetch('/api/calendar-events/')
            .then(r => r.ok ? r.json() : Promise.reject('Failed to fetch task events'))
            .then(taskData => {
              const taskEvents = taskData && taskData.events ? taskData.events : [];
              return userEvents.concat(taskEvents);
            });
        })
        .then(allEvents => {
          displayTaskEvents(serverContainer, allEvents);
        })
        .catch(err => {
          console.warn('Could not load server calendar events:', err);
          displayTaskEvents(serverContainer, []);
        });
    }

    if (!src) {
      area.className = 'calendar-placeholder';
      area.textContent = title ? title : 'No calendar configured. Click "Add Calendar" to paste a Google Calendar embed link.';
      fetchAndDisplay(area);
      return;
    }

    // Ensure the src is suitable for iframe
    const iframe = document.createElement('iframe');
    iframe.className = 'calendar-iframe';
    iframe.loading = 'lazy';
    iframe.referrerPolicy = 'no-referrer-when-downgrade';
    iframe.src = src;
    iframe.setAttribute('aria-label', 'User calendar');

    area.className = '';
    area.appendChild(iframe);
    fetchAndDisplay(area);
  }

  function displayTaskEvents(container, serverEvents = []) {
    const EVENTS_KEY = 'planny_calendar_events';
    let events = [];

    // load local events
    const eventsJson = localStorage.getItem(EVENTS_KEY);
    if (eventsJson) {
      try {
        const local = JSON.parse(eventsJson);
        if (Array.isArray(local)) events = events.concat(local);
      } catch (e) {
        console.warn('Invalid local calendar events JSON', e);
      }
    }

    // merge server events
    if (Array.isArray(serverEvents) && serverEvents.length) {
      events = events.concat(serverEvents);
    }

    if (!events || events.length === 0) return;

    try {
      const eventsSection = document.createElement('div');
      eventsSection.className = 'calendar-events-section';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.display = 'flex';
      headerDiv.style.justifyContent = 'space-between';
      headerDiv.style.alignItems = 'center';
      headerDiv.style.marginBottom = '10px';
      
      const header = document.createElement('div');
      header.className = 'calendar-events-header';
      header.textContent = `üìã Upcoming Events (${events.length})`;
      headerDiv.appendChild(header);
      
      const newEventBtn = document.createElement('button');
      newEventBtn.className = 'btn-new-event';
      newEventBtn.textContent = '+ New Event';
      newEventBtn.onclick = () => openEventModal();
      headerDiv.appendChild(newEventBtn);
      
      eventsSection.appendChild(headerDiv);

      // Sort events by date
      const sortedEvents = events.sort((a, b) => {
        const dateA = new Date(a.start?.date || a.start?.dateTime || '');
        const dateB = new Date(b.start?.date || b.start?.dateTime || '');
        return dateA - dateB;
      });

      sortedEvents.forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'calendar-event-item';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'calendar-event-content';
        
        const title = document.createElement('div');
        title.className = 'calendar-event-title';
        title.textContent = event.summary || 'Untitled Event';
        contentDiv.appendChild(title);

        if (event.start?.date) {
          const dateSpan = document.createElement('div');
          dateSpan.className = 'calendar-event-date';
          const date = new Date(event.start.date + 'T00:00:00');
          dateSpan.textContent = `üìÖ ${date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}`;
          contentDiv.appendChild(dateSpan);
        }

        if (event.description) {
          const desc = document.createElement('div');
          desc.className = 'calendar-event-project';
          const projectMatch = event.description.match(/Project:\s*(.+?)(?:\n|$)/);
          if (projectMatch) {
            desc.textContent = `üì¶ ${projectMatch[1]}`;
            contentDiv.appendChild(desc);
          } else if (event.description.trim()) {
            desc.textContent = event.description.substring(0, 50);
            desc.className = 'calendar-event-project';
            contentDiv.appendChild(desc);
          }
        }

        eventDiv.appendChild(contentDiv);

        // Add action buttons only for user-created events (not task-based)
        if (event.eventID) {
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'calendar-event-actions';

          const editBtn = document.createElement('button');
          editBtn.className = 'btn-edit-event';
          editBtn.textContent = 'Edit';
          editBtn.onclick = (e) => {
            e.stopPropagation();
            openEventModal(event.eventID);
          };
          actionsDiv.appendChild(editBtn);

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn-delete-event';
          deleteBtn.textContent = 'Delete';
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteEvent(event.eventID);
          };
          actionsDiv.appendChild(deleteBtn);

          eventDiv.appendChild(actionsDiv);
        }

        eventsSection.appendChild(eventDiv);
      });

      container.appendChild(eventsSection);
    } catch (e) {
      console.error('Error displaying calendar events:', e);
    }
  }
</script>
      <div class="container-fluid">
        <div class="header-body">
        </div>
      </div>
    </div>

   <div class="container-fluid mt--7">

      <div class="row">
        <div class="col">
          <div class="card shadow">
              <div class="card-header bg-transparent">
                <div class="calendar-top-bar">
                  <h3 class="mb-0">Calendar</h3>
                  <div style="display:flex; gap:8px;">
                    <button class="btn-new-event" onclick="openEventModal()">+ New Event</button>
                    <button class="btn-new-calendar" onclick="openCalendarModal()">‚öôÔ∏è Calendar Settings</button>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="calendar-container">
                  <div id="calendarArea" class="calendar-placeholder">
                    No calendar configured. Click "Add Calendar" to paste a Google Calendar embed link.
                  </div>
                </div>
              </div>
          </div>
        </div>
      </div>

      {% include "includes/footer.html" %}

    </div>

{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block javascripts %}

<script src="/static/assets/vendor/clipboard/dist/clipboard.min.js"></script>

{% endblock javascripts %}
