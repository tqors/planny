{% extends 'layouts/base.html' %}

{% block title %} Kanban Board {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<style>
  .kanban-container {
    display: flex;
    gap: 20px;
    overflow-x: auto;
    padding-bottom: 20px;
  }

  .kanban-column {
    flex: 0 0 350px;
    background-color: #f5f5f5;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .kanban-column-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    font-weight: 600;
    color: #333;
    font-size: 16px;
  }

  .kanban-column-header .badge {
    background-color: #ddd;
    color: #333;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: normal;
  }

  .kanban-cards {
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-height: 100px;
  }

  .kanban-card {
    background-color: white;
    border-radius: 6px;
    padding: 15px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    cursor: grab;
    transition: all 0.2s;
  }

  .kanban-card:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
  }

  .kanban-card:active {
    cursor: grabbing;
  }

  .kanban-card-title {
    font-weight: 600;
    margin-bottom: 8px;
    color: #333;
    word-wrap: break-word;
  }

  .kanban-card-description {
    font-size: 13px;
    color: #666;
    margin-bottom: 10px;
    line-height: 1.4;
    word-wrap: break-word;
  }

  .kanban-card-meta {
    font-size: 12px;
    color: #888;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .kanban-card-meta-item {
    display: flex;
    justify-content: space-between;
  }

  .kanban-card-label {
    font-weight: 500;
    color: #555;
  }

  .kanban-card-value {
    color: #999;
  }

  .add-column-button {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 150px;
    background-color: #f9f9f9;
    border: 2px dashed #ddd;
    border-radius: 6px;
    color: #999;
    cursor: pointer;
    transition: all 0.2s;
  }

  .add-column-button:hover {
    border-color: #007bff;
    color: #007bff;
    background-color: #f0f7ff;
  }

  /* Status-specific colors */
  .status-todo {
    border-left: 4px solid #6c757d;
  }

  .status-in-progress {
    border-left: 4px solid #ffc107;
  }

  .status-bug-report {
    border-left: 4px solid #dc3545;
  }

  .status-testing {
    border-left: 4px solid #17a2b8;
  }

  .status-complete {
    border-left: 4px solid #28a745;
  }

  .modal-dialog-centered {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: calc(100% - 3.5rem);
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
    color: #333;
  }

  .form-group input,
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    font-family: inherit;
  }

  .form-group textarea {
    resize: vertical;
    min-height: 80px;
  }

  .form-group input:focus,
  .form-group textarea:focus,
  .form-group select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
  }

  .modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
  }

  .modal-buttons button {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-save {
    background-color: #007bff;
    color: white;
  }

  .btn-save:hover {
    background-color: #0056b3;
  }

  .btn-cancel {
    background-color: #e9ecef;
    color: #333;
  }

  .btn-cancel:hover {
    background-color: #dee2e6;
  }

  .btn-new-task {
    background-color: #28a745;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    margin-bottom: 20px;
    transition: all 0.2s;
  }

  .btn-new-task:hover {
    background-color: #218838;
  }

  .kanban-top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .kanban-top-bar h3 {
    margin: 0;
    color: #333;
  }

  .overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 999;
    align-items: center;
    justify-content: center;
  }

  .overlay.active {
    display: flex;
  }

  .modal-content {
    background-color: white;
    border-radius: 8px;
    padding: 30px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  }

  .modal-header {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 20px;
    color: #333;
  }

  .loading {
    display: none;
    text-align: center;
    padding: 20px;
  }

  .loading.active {
    display: block;
  }

  .spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .error-message {
    color: #dc3545;
    font-size: 14px;
    margin-top: 5px;
    display: none;
  }

  .error-message.active {
    display: block;
  }

  .success-message {
    color: #28a745;
    font-size: 14px;
    margin-top: 5px;
    display: none;
  }

  .success-message.active {
    display: block;
  }
</style>
{% endblock stylesheets %}

{% block content %}
    <!-- Header -->
    <div class="header bg-gradient-primary pb-8 pt-5 pt-md-8">
      <div class="container-fluid">
        <div class="header-body">
          <div class="row">
            <div class="col-lg-12 col-md-12">
              <h1 class="display-2 text-white">Kanban Board</h1>
              <p class="text-white mt-0 mb-0">Manage your tasks with ease</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid mt--7">
      <div class="row">
        <div class="col">
          <div class="card shadow">
            <div class="card-header bg-transparent">
              <div class="kanban-top-bar">
                <div>
                  <h3 class="mb-0" style="display: inline-block; margin-right: 20px;">Project Tasks</h3>
                  <select id="projectFilter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="">-- All Projects --</option>
                  </select>
                </div>
                <button class="btn-new-task" onclick="openTaskModal()">+ New Task</button>
              </div>
            </div>
            <div class="card-body">
              <div class="kanban-container" id="kanbanContainer">
                <!-- Kanban columns will be generated here by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>

      {% include "includes/footer.html" %}
    </div>

    <!-- Task Modal -->
    <div class="overlay" id="taskOverlay">
      <div class="modal-content">
        <div class="modal-header">
          Create New Task
        </div>
        <form id="taskForm">
          <div class="form-group">
            <label for="taskTitle">Task Title *</label>
            <input type="text" id="taskTitle" name="taskTitle" placeholder="Enter task title" required>
            <span class="error-message" id="titleError"></span>
          </div>

          <div class="form-group">
            <label for="taskDescription">Task Description</label>
            <textarea id="taskDescription" name="taskDescription" placeholder="Enter task description"></textarea>
            <span class="error-message" id="descError"></span>
          </div>

          <div class="form-group">
            <label for="taskStatus">Status *</label>
            <select id="taskStatus" name="taskStatus" required>
              <option value="">-- Select Status --</option>
              <option value="1">To-Do</option>
              <option value="2">In Progress</option>
              <option value="3">Bug Report</option>
              <option value="4">Testing</option>
              <option value="5">Complete</option>
            </select>
            <span class="error-message" id="statusError"></span>
          </div>

          <div class="form-group">
            <label for="taskDueDate">Due Date</label>
            <input type="date" id="taskDueDate" name="taskDueDate">
            <span class="error-message" id="dueDateError"></span>
          </div>

          <div class="form-group">
            <label for="taskAssignedTo">Assigned To</label>
            <select id="taskAssignedTo" name="taskAssignedTo" id="assignedToSelect">
              <option value="">-- Select Developer --</option>
              <!-- Options will be populated by JavaScript -->
            </select>
            <span class="error-message" id="assignedError"></span>
          </div>

          <div class="form-group">
            <label for="taskProject">Project *</label>
            <select id="taskProject" name="taskProject" required>
              <option value="">-- Select Project --</option>
              <!-- Options will be populated by JavaScript -->
            </select>
            <span class="error-message" id="projectError"></span>
          </div>

          <div class="loading" id="formLoading">
            <div class="spinner"></div>
            <p>Saving task...</p>
          </div>

          <div class="success-message" id="successMessage">Task created successfully!</div>

          <div class="modal-buttons">
            <button type="button" class="btn-cancel" onclick="closeTaskModal()">Cancel</button>
            <button type="submit" class="btn-save">Create Task</button>
          </div>
        </form>
      </div>
    </div>

{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block javascripts %}

<script src="/static/assets/vendor/clipboard/dist/clipboard.min.js"></script>

<script>
  const statusMap = {
    '1': 'To-Do',
    '2': 'In Progress',
    '3': 'Bug Report',
    '4': 'Testing',
    '5': 'Complete'
  };

  const statusClasses = {
    '1': 'status-todo',
    '2': 'status-in-progress',
    '3': 'status-bug-report',
    '4': 'status-testing',
    '5': 'status-complete'
  };

  // Initialize the kanban board
  document.addEventListener('DOMContentLoaded', function() {
    loadKanbanData();
    loadProjects();
    loadDevelopers();
    
    // Add event listener for project filter
    document.getElementById('projectFilter').addEventListener('change', filterKanbanByProject);
  });

  // Load kanban data from the server
  function loadKanbanData() {
    fetch('/api/kanban-tasks/', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to load tasks');
      }
      return response.json();
    })
    .then(data => {
      // Store all tasks globally for filtering
      window.allTasks = data.tasks;
      renderKanban(data.tasks);
    })
    .catch(error => {
      console.error('Error loading kanban data:', error);
      showErrorMessage('Failed to load tasks. Please refresh the page.');
    });
  }

  // Filter kanban by selected project
  function filterKanbanByProject() {
    const selectedProjectId = document.getElementById('projectFilter').value;
    
    if (selectedProjectId === '') {
      // Show all tasks
      renderKanban(window.allTasks);
    } else {
      // Filter tasks by project
      const filteredTasks = window.allTasks.filter(task => 
        task.projectID === parseInt(selectedProjectId)
      );
      renderKanban(filteredTasks);
    }
  }

  // Render the kanban board
  function renderKanban(tasks) {
    const container = document.getElementById('kanbanContainer');
    container.innerHTML = '';

    const statusOrder = ['1', '2', '3', '4', '5'];

    statusOrder.forEach(statusId => {
      const statusTasks = tasks.filter(task => task.statusID === parseInt(statusId));
      
      const column = document.createElement('div');
      column.className = 'kanban-column';
      column.innerHTML = `
        <div class="kanban-column-header">
          <span>${statusMap[statusId]}</span>
          <span class="badge">${statusTasks.length}</span>
        </div>
        <div class="kanban-cards" id="column-${statusId}">
          ${statusTasks.map(task => `
            <div class="kanban-card ${statusClasses[statusId]}" draggable="true" data-task-id="${task.taskID}" ondragstart="dragStart(event)" ondragend="dragEnd(event)">
              <div class="kanban-card-title">${escapeHtml(task.taskTitle)}</div>
              <div class="kanban-card-description">${escapeHtml(task.taskDescription || 'No description')}</div>
              <div class="kanban-card-meta">
                <div class="kanban-card-meta-item">
                  <span class="kanban-card-label">Project:</span>
                  <span class="kanban-card-value">${escapeHtml(task.projectName)}</span>
                </div>
                <div class="kanban-card-meta-item">
                  <span class="kanban-card-label">Due:</span>
                  <span class="kanban-card-value">${task.dueDate || 'No date'}</span>
                </div>
                <div class="kanban-card-meta-item">
                  <span class="kanban-card-label">Assigned:</span>
                  <span class="kanban-card-value">${task.assignedToName || 'Unassigned'}</span>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      // Add drag-over listeners
      const cardsContainer = column.querySelector(`#column-${statusId}`);
      cardsContainer.addEventListener('dragover', dragOver);
      cardsContainer.addEventListener('drop', drop);

      container.appendChild(column);
    });
  }

  // Drag and drop handlers
  let draggedElement = null;

  function dragStart(event) {
    draggedElement = event.target.closest('.kanban-card');
    event.dataTransfer.effectAllowed = 'move';
  }

  function dragEnd(event) {
    draggedElement = null;
  }

  function dragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
  }

  function drop(event) {
    event.preventDefault();
    if (!draggedElement) return;

    const targetColumn = event.currentTarget;
    const statusId = targetColumn.id.split('-')[1];
    const taskId = draggedElement.dataset.taskId;

    // Update task status on the server
    updateTaskStatus(taskId, statusId);

    // Move the card to the new column
    targetColumn.appendChild(draggedElement);
    
    // Update column badge counts
    updateColumnBadges();
  }

  // Update task status via API
  function updateTaskStatus(taskId, newStatusId) {
    fetch(`/api/kanban-tasks/${taskId}/`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ statusID: parseInt(newStatusId) })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to update task status');
      }
      return response.json();
    })
    .then(data => {
      console.log('Task updated:', data);
      // Reload the kanban board
      loadKanbanData();
    })
    .catch(error => {
      console.error('Error updating task status:', error);
      // Reload to revert the UI change
      loadKanbanData();
    });
  }

  // Update column badge counts
  function updateColumnBadges() {
    document.querySelectorAll('.kanban-cards').forEach(column => {
      const cards = column.querySelectorAll('.kanban-card').length;
      const badge = column.parentElement.querySelector('.badge');
      if (badge) {
        badge.textContent = cards;
      }
    });
  }

  // Load projects for the dropdown
  function loadProjects() {
    fetch('/api/projects/', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      }
    })
    .then(response => response.json())
    .then(data => {
      const projectSelect = document.getElementById('taskProject');
      const projectFilter = document.getElementById('projectFilter');
      
      data.projects.forEach(project => {
        // Add to task creation dropdown
        const option = document.createElement('option');
        option.value = project.projectID;
        option.textContent = project.projectName;
        projectSelect.appendChild(option);
        
        // Add to project filter dropdown
        const filterOption = document.createElement('option');
        filterOption.value = project.projectID;
        filterOption.textContent = project.projectName;
        projectFilter.appendChild(filterOption);
      });
    })
    .catch(error => {
      console.error('Error loading projects:', error);
    });
  }

  // Load developers for the dropdown
  function loadDevelopers() {
    fetch('/api/developers/', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      }
    })
    .then(response => response.json())
    .then(data => {
      const developerSelect = document.getElementById('taskAssignedTo');
      data.developers.forEach(developer => {
        const option = document.createElement('option');
        option.value = developer.developerID;
        option.textContent = developer.firstName + ' ' + developer.lastName;
        developerSelect.appendChild(option);
      });
    })
    .catch(error => {
      console.error('Error loading developers:', error);
    });
  }

  // Open task modal
  function openTaskModal() {
    document.getElementById('taskOverlay').classList.add('active');
    document.getElementById('taskForm').reset();
    clearErrors();
  }

  // Close task modal
  function closeTaskModal() {
    document.getElementById('taskOverlay').classList.remove('active');
    document.getElementById('taskForm').reset();
    clearErrors();
  }

  // Clear error messages
  function clearErrors() {
    document.querySelectorAll('.error-message').forEach(el => {
      el.classList.remove('active');
      el.textContent = '';
    });
    document.getElementById('successMessage').classList.remove('active');
  }

  // Save calendar event to localStorage
  function saveCalendarEvent(event) {
    const EVENTS_KEY = 'planny_calendar_events';
    let events = [];
    const stored = localStorage.getItem(EVENTS_KEY);
    if (stored) {
      try {
        events = JSON.parse(stored);
      } catch (e) {
        events = [];
      }
    }
    
    // Check if event already exists
    const exists = events.some(e => e.taskID === event.taskID);
    if (!exists) {
      events.push(event);
      localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
      console.log('Calendar event saved:', event);
    }
  }

  // Create calendar event after task is created
  function createCalendarEvent(taskId) {
    fetch('/api/calendar-event/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ taskID: taskId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.event) {
        saveCalendarEvent(data.event);
        console.log('Event added to calendar');
      }
    })
    .catch(error => {
      console.error('Error creating calendar event:', error);
      // Don't fail task creation if calendar event fails
    });
  }

  // Handle form submission
  document.getElementById('taskForm').addEventListener('submit', function(event) {
    event.preventDefault();
    
    clearErrors();

    const title = document.getElementById('taskTitle').value.trim();
    const description = document.getElementById('taskDescription').value.trim();
    const status = document.getElementById('taskStatus').value;
    const dueDate = document.getElementById('taskDueDate').value;
    const assignedTo = document.getElementById('taskAssignedTo').value;
    const project = document.getElementById('taskProject').value;

    // Validation
    if (!title) {
      showError('titleError', 'Task title is required');
      return;
    }

    if (!status) {
      showError('statusError', 'Please select a status');
      return;
    }

    if (!project) {
      showError('projectError', 'Please select a project');
      return;
    }

    // Show loading
    document.getElementById('formLoading').classList.add('active');

    // Submit form
    fetch('/api/kanban-tasks/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        taskTitle: title,
        taskDescription: description,
        statusID: parseInt(status),
        dueDate: dueDate || null,
        assignedTo: assignedTo ? parseInt(assignedTo) : null,
        projectID: parseInt(project)
      })
    })
    .then(response => {
      document.getElementById('formLoading').classList.remove('active');
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.error || 'Failed to create task');
        });
      }
      return response.json();
    })
    .then(data => {
      document.getElementById('successMessage').classList.add('active');
      setTimeout(() => {
        // Get the created task ID from response if available, or fetch it
        createCalendarEvent(data.taskID || 'latest');
        closeTaskModal();
        loadKanbanData();
      }, 1500);
    })
    .catch(error => {
      document.getElementById('formLoading').classList.remove('active');
      console.error('Error creating task:', error);
      showError('titleError', error.message);
    });
  });

  // Helper functions
  function showError(elementId, message) {
    const errorEl = document.getElementById(elementId);
    errorEl.textContent = message;
    errorEl.classList.add('active');
  }

  function showErrorMessage(message) {
    const errorEl = document.getElementById('titleError');
    errorEl.textContent = message;
    errorEl.classList.add('active');
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Close modal when clicking outside
  document.getElementById('taskOverlay').addEventListener('click', function(event) {
    if (event.target === this) {
      closeTaskModal();
    }
  });
</script>

{% endblock javascripts %}
